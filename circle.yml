general:
  artifacts:
    # Compiled assets
    - plottable.js
    - plottable.css
    # Demo paths
    - quicktests
    # Modules used by quicktests
    - node_modules/d3
    - node_modules/jquery
    - node_modules/requirejs

machine:
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
  node:
    version: 8.8.1

dependencies:
  override:
    - yarn install --no-progress
    - echo "Checking if yarn.lock changed..." && git diff --exit-code
  cache_directories:
    - ~/.cache/yarn

test:
  override:
    - yarn test:ci

deployment:
  publish-npm-next:
    branch: develop
    owner: palantir
    commands:
      - echo -e "$NPM_USER\n$NPM_PASS\n$NPM_EMAIL" | npm login
      - ./publishSnapshot.sh
      - ./demo.js
  demo:
    branch: /.*/
    owner: palantir
    commands:
      - ./demo.js || true
  publish-npm-latest:
    tag: /v[0-9.]+(-(beta|rc)[0-9.]*)?$/
    owner: palantir
    commands:
      # Confirm we are ready to publish
      - yarn dist
      - git diff HEAD..origin/develop --quiet || (echo "dist not built"; exit 1)
      - npm run -s check_version || (echo "package.json version not updated"; exit 1)
      # Publish
      - echo -e "$NPM_USER\n$NPM_PASS\n$NPM_EMAIL" | npm login
      - npm publish
